### 区块和交易的生成与验证

#### transaction.py

这段代码实现了一个简单的交易系统，包括生成和管理交易、交易池管理、以及广播交易等功能。交易通过 `TransactionMessage` 类进行表示，并存储在本地交易池中。定时生成交易并广播到已知的对等节点（`known_peers`）。交易池中的交易 ID 被追踪，以确保不会添加重复交易。

1. `transaction_generation`

   **功能**：定期生成交易并将其添加到本地交易池中，交易的发送方是 `self_id`，接收方从已知对等节点中随机选择。每隔指定时间（默认为15秒）生成一个新的交易并广播。

2. `add_transaction`

   **功能**：将新的交易添加到本地的交易池中（`tx_pool`）。该函数会首先检查交易的 `id` 是否已经存在于交易池中，如果不存在，则将交易添加到池中，并将其 `id` 添加到 `tx_ids` 集合中，确保不会有重复的交易。

3. `get_recent_transactions`

   **功能**：返回当前交易池中的所有交易，以字典格式返回。

4. `clear_pool`

   **功能**：清空交易池（`tx_pool`）和交易 ID 集合（`tx_ids`）。

#### block_handler.py

该代码实现了一个简单的区块链系统，涵盖区块的生成、同步、验证、存储等核心功能。系统中节点通过网络传播区块和交易信息，确保区块链的去中心化和一致性。每个节点可以生成新的区块并将其广播到网络中的其他节点，同时也可以接收其他节点的区块进行同步，处理孤块（即缺失前置区块的区块），并维护区块链的最新状态。

以下为主要函数的功能介绍：

1. `request_block_sync`

   **功能**：用于请求区块同步。当新节点加入时，它需要请求已知节点发送区块头信息。同步请求分为两种：

   - 对于新节点，会请求一定范围内的区块头（每次最多100个区块头）。
   - 对于常规节点，会请求最新的区块头信息。

2. `block_generation`

   **功能**：定期生成新区块。区块生成过程涉及等待区块同步完成，生成新的区块（可能包含恶意模式，生成随机区块ID）并广播。

3. `create_dummy_block`

   **功能**：生成一个虚拟区块，包含交易信息，并计算区块的哈希值。

4. `compute_block_hash`

   **功能**：计算区块的哈希值（排除 `block_id` 字段）。

5. `handle_block`

   **功能**：处理接收到的区块，验证区块的有效性，确保区块的顺序和一致性。

6. `create_getblock`

   **功能**：创建 `GETBLOCK` 请求消息，用于请求特定区块。

#### inv_message.py

这段代码主要用于处理区块链中的区块清单广播（`INV` 消息）。在一个去中心化的区块链网络中，节点之间会广播他们所拥有的区块ID（即区块清单），以便其他节点同步区块。该代码实现了生成区块清单消息、获取本地区块清单、以及广播区块清单的功能。

1. `create_inv`

   **功能**：生成一个 `INV` 消息，这个消息包含了发送者的ID、发送的区块ID和消息ID。

2. `get_inventory`

   **功能**：返回本地区块链（`received_blocks`）中的所有区块ID。

3. `broadcast_inventory`

   **功能**：广播本地区块链的区块清单。

### Bonus2

#### fanout参数变化对冗余消息的影响

本实验采用五个节点（peer0-4），控制时间在3分钟、节点总数为11个的情况下，分别对fanout为1和10测试4组，以下为实验数据以及用用`Python`程序绘制的图表：

![data1](/Users/hlshen/Desktop/CS305-2025Spring-FinalProject/report/images/data1.jpg)

![fanout_avg_comparison](/Users/hlshen/Desktop/CS305-2025Spring-FinalProject/fanout_avg_comparison.png)

##### 实验结论：

- **较高的`fanout`会导致更多的冗余消息**：

  在 `fanout=10` 的情况下，相比 `fanout=1`，冗余消息的数量显著增加。这表明，较高的 fanout 值会将消息传播到更多的对等节点，从而导致更多的冗余消息在网络中传输。

- `NAT=true`的节点对`fanout`的敏感程度更高，Peer2和Peer3的增长幅度分别为78.4%和39.5%

#### 有无NAT对冗余消息的影响

本实验在fanout=10的情况下，控制时间为3分钟，分别对Peer1 (NAT=False) 和 Peer2 (NAT=True) 测试5次，以下为实验数据以及用用`Python`程序绘制的图表：

![data2](/Users/hlshen/Desktop/CS305-2025Spring-FinalProject/report/images/data2.jpg)

![experiment_comparison_with_avg](/Users/hlshen/Desktop/CS305-2025Spring-FinalProject/experiment_comparison_with_avg.png)

##### 实验结论：

`NAT=True`时冗余消息更少，分析原因如下：

1. **NAT 限制了消息传播的范围**：
   - 在 NAT 环境中，网络地址转换会限制节点与外部网络的直接连接，因此 **Peer2** 在接收到的消息传播上会受到限制。NAT 会导致对等节点的消息只会在特定的网络范围内传播，减少了消息的冗余传播。

2. **节点之间的直接通信受限**：

   - 没有 NAT 的节点（如 **Peer1**）通常能更容易地直接与其他节点建立连接并交换信息，从而导致更多的冗余消息（由于信息传播给更多的对等节点）。

   - 但是有 NAT 的节点通常需要通过某些中介节点或路由器进行通信，消息传播的范围减少，这减少了冗余消息的数量。

3. **NAT 防止了多路径传播**：
   - 在没有 NAT 的情况下，消息可能会通过多个路径传播到其他节点，从而增加冗余消息的数量。而有 NAT 的节点通常只能通过有限的路径传播消息，导致冗余消息的传播受到控制。

#### 节点总数对冗余消息的影响

本实验对Peer0，在fanout=10，时间控制在3分钟的情况下，分别在总节点数为11和20的情况下测试5组，以下为实验数据以及用用`Python`程序绘制的图表：

![data3](/Users/hlshen/Desktop/CS305-2025Spring-FinalProject/report/images/data3.jpg)

![experiment_comparison_with_peer_number](/Users/hlshen/Desktop/CS305-2025Spring-FinalProject/experiment_comparison_with_peer_number.png)

##### 实验结论：

节点数为20时产生的冗余消息比节点数为11产生的冗余消息多，分析原因如下：

1. **更多的节点导致更多的消息传播**：
   - 当节点数量增加时，消息会传播给更多的节点。对于每个消息，多个节点接收到消息后，消息可能会被进一步广播给更多的对等节点，导致冗余消息数目增加。特别是在一个去中心化的网络中，增加节点数目意味着消息传播范围扩大，从而产生更多的冗余消息。

2. **消息传递的覆盖率更广**：
   - 当网络中的节点更多时，每个节点的消息覆盖范围也变得更广，导致每条消息被更多的节点复制和传播。这直接导致了冗余消息的数量增加，因为相同的消息会在更多节点之间传播。

3. **信息传播的复杂性增加**：
   - 当网络中的节点增加时，信息的传播和管理变得更为复杂，特别是当不同节点之间存在不同的传播路径时。节点数越多，冗余消息被重复传递的可能性就越高。